---
title: "Plant schisto LTs"
author: "DJC"
date: "11/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Code for analysis of plant schisto LTs
Previously, we had applied GAMMs to these life table results from 2 experiments, but I think that was a mistake because the added complexity isn't really needed.

Here, we reanalyze the data using the final length and weekly averages of eggs and cercs as response variables, following methods from Civitello and Hartman 2020, Ecology and Johnson et al. 2014, Proc B, specifically just calculating weekly averages of egg laying and cerc shedding.
```{r packages, message=FALSE}
library(dplyr)
library(glmmTMB)
library(ggplot2)
library(cowplot)
library(emmeans)
library(stringr)
library(survival)
library(multcomp)
library(multcompView)
theme_set(theme_cowplot())
```


```{r data}
Betty_lt = read.csv("C:/RData/Dan Dissertation/Detritus LTs/Plant_species_LT.csv")
Betty_lt[,"Food"][which(Betty_lt[,"Food"] == "Good lab food")] = "Lab food"
Betty_lt[,"Status"] = ifelse(Betty_lt[,"Alive"]==0, 1, 0)


L_max = aggregate(Length ~ Snail, FUN=max, data=Betty_lt)
C_tot = aggregate(Cerc ~ Snail, FUN=sum, data=Betty_lt, drop=F)
E_tot = aggregate(Eggs ~ Snail, FUN=sum, data=Betty_lt)
Surv = aggregate(Alive ~ Snail, FUN=sum, data=Betty_lt)
Censored = aggregate(Status ~ Snail, FUN=max, data=Betty_lt)
Infected = aggregate(Infected ~ Snail, FUN=unique, data=Betty_lt)
Food = aggregate(Food ~ Snail, FUN=unique, data=Betty_lt)

snails = full_join(Infected, Food, by="Snail")
snails = full_join(snails, L_max, by="Snail")
snails = full_join(snails, C_tot, by="Snail")
snails = full_join(snails, E_tot, by="Snail")
snails = full_join(snails, Surv, by="Snail")
snails = full_join(snails, Censored, by="Snail")
snails[,"Status"] = snails[,"Status"]*3 # For AFT interval model
snails[,"First_dead"] = snails[,"Alive"] + 1
snails[,"Food"] <- factor(snails[,"Food"], levels = c("Lab food", "Azolla", "Duckweed", "Water hyacinth", "Water lettuce"))
```

```{r per_week_analysis}
snails[,"Cerc_wk"] = snails[,"Cerc"]/(snails[,"Alive"]-3)
snails[,"Egg_wk"] = snails[,"Eggs"]/(snails[,"Alive"])

Lengths = lm(Length ~ Infected*Food, data=snails)
#summary(Lengths)
contrast_matrix_L = emmeans(Lengths, pairwise ~ Food*Infected)

Eggs = lm(log(Egg_wk+1) ~ Infected*Food, data=snails)
#summary(Eggs)
contrast_matrix_E = emmeans(Eggs, pairwise ~ Food*Infected)

Cercs = lm(log(Cerc_wk+1) ~ Food, data=subset(snails, Infected=="Y"))
#summary(Cercs)
contrast_matrix_C = emmeans(Cercs, pairwise ~ Food)$emmeans

Dead = survreg(Surv(time=Alive, time2=First_dead, event=Status, type="interval") ~ Infected*Food, data=snails)
#summary(Dead)
contrast_matrix_D = emmeans(Dead, pairwise ~ Food*Infected) 


```

## Generating treatment summaries - means & SEs
```{r treatments}
# Get means and SEs
meanL = aggregate(Length ~ Food*Infected, FUN=mean, data=snails)
meanE = aggregate(Egg_wk ~ Food*Infected, FUN=mean, data=snails)
meanC = aggregate(Cerc_wk ~ Food*Infected, FUN=mean, data=snails)

SEM <- function(x){sd(x)/sqrt(length(na.omit(x)))}

SE_L = aggregate(Length ~ Food*Infected, FUN=SEM, data=snails)
SE_E = aggregate(Egg_wk ~ Food*Infected, FUN=SEM, data=snails)
SE_C = aggregate(Cerc_wk ~ Food*Infected, FUN=SEM, data=snails)

treatments = data.frame(meanL, "Length_SE" = SE_L$Length, "Eggs" =meanE$Egg_wk, "Eggs_SE" = SE_E$Egg_wk)
treatments = full_join(treatments, meanC, by=c("Food", "Infected"))
treatments = full_join(treatments, SE_C, by=c("Food", "Infected"))
treatments = rename(treatments, Cercs = Cerc_wk.x)
treatments = rename(treatments, Cercs_SE = Cerc_wk.y)
treatments[,"Infected"] = ifelse(treatments[,"Infected"] == "N", "No", "Yes")
treatments[,"Surv"] = data.frame(emmeans(Dead, pairwise ~ Food*Infected, type="response")$emmeans)$response
treatments[,"Surv_SE"] = data.frame(emmeans(Dead, pairwise ~ Food*Infected, type="response")$emmeans)$SE

# No deaths observed in Unexposed Duckweed
treatments[3, c("Surv", "Surv_SE")] = NA

treatments[,"L_labs"] = str_trim(cld(contrast_matrix_L, Letters=letters, sort=F)$.group, "both")
treatments[,"E_labs"] = str_trim(cld(contrast_matrix_E, Letters=letters, sort=F)$.group, "both")
treatments[,"C_labs"] = str_trim(c(rep(NA, times=5), cld(contrast_matrix_C, Letters=letters, sort=F)$.group), "both")
treatments[,"S_labs"] = str_trim(cld(contrast_matrix_D, Letters=letters, sort=F)$.group, "both")


```


## Building Plots

```{r plots}
pL = ggplot(data=treatments, aes(x=Food, y=Length, shape=Infected, fill=Infected)) + 
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position=c(0.05, 0.2), legend.title=element_text(size=10), legend.text=element_text(size=9), legend.spacing.x = unit(0, "cm"), 
        legend.spacing.y = unit(0, "cm"),
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + 
  geom_linerange(aes(ymin=Length - Length_SE, ymax=Length + Length_SE), position = position_dodge(width=0.2)) +
  geom_point(position = position_dodge(width=0.2)) + geom_text(aes(label=L_labs, 
    hjust=rep(c(1, 0), each=5)), position = position_dodge(width=0.5)) +
  scale_shape_manual(values=c(21, 21)) + scale_fill_manual(values = c("white", "black")) + ylim(c(0,20))

pE = ggplot(data=treatments, aes(x=Food, y=Eggs, shape=Infected, fill=Infected)) + 
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position="none",
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + 
  geom_linerange(aes(ymin=Eggs - Eggs_SE, ymax=Eggs + Eggs_SE), position = position_dodge(width=0.3)) +
  geom_point(position = position_dodge(width=0.3)) + geom_text(aes(label=E_labs, 
    hjust=rep(c(1, 0), each=5)), position = position_dodge(width=0.6)) +
  scale_shape_manual(values=c(21, 21)) + scale_fill_manual(values = c("white", "black"))

pC = ggplot(data=treatments, aes(x=Food, y=Cercs)) + geom_point() + geom_text(aes(label=C_labs), nudge_x = 0.15) +
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position="none", 
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + ylim(c(0,1300)) +
  geom_linerange(aes(ymin=Cercs - Cercs_SE, ymax=Cercs + Cercs_SE)) 

pD = ggplot(data=treatments, aes(x=Food, y=Surv, shape=Infected, fill=Infected)) + 
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position="none",
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_text(size=8, margin = margin(t=3)),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + 
  geom_linerange(aes(ymin=Surv - Surv_SE, ymax=Surv + Surv_SE), position = position_dodge(width=0.3)) +
  geom_point(position = position_dodge(width=0.3)) + geom_text(aes(label=S_labs, 
    hjust=rep(c(1, 0), each=5)), position = position_dodge(width=0.6)) +
  scale_shape_manual(values=c(21, 21)) + scale_fill_manual(values = c("white", "black")) +
  scale_x_discrete(labels =  c("Lab\nfood", "Azolla", "Duckweed", "Water\nhyacinth", "Water\nlettuce"))

```


```{r plot_grid}
Fig1 = plot_grid(pL, pE, pC, pD, align="v", ncol=1, nrow=4, axis="rltb", scale=1) +
  # y-axis labels
  draw_label("Final length, mm ± SE", x=0.04, y=0.9, angle=90, size=10) +
  draw_label("Weekly reproduction\nrate ± SE", x=0.04, y=0.65, angle=90, size=10) +
  draw_label("Cercarial production\nrate ± SE", x=0.04, y=0.45, angle=90, size=10) +
  draw_label("Estimated Median\nsurvival, weeks ± SE", x=0.04, y=0.15, angle=90, size=10) +
  # x-axis labels
  draw_label("Food resource", x = 0.55, y = 0.02, size=10) +
  # panel labels
  draw_label("A", x = 0.2, y = 0.99, size=10) + 
  draw_label("B", x = 0.2, y = 0.75, size=10) +
  draw_label("C", x = 0.2, y = 0.5, size=10) +
  draw_label("D", x = 0.2, y = 0.25, size=10) +
  # Note for uninfected duckweed survival
  draw_label("No\ndeaths", x=0.53, y=0.2, size=7)

setwd("C:/RData")
save_plot("Fig1_Detritus.png", Fig1, ncol=1, nrow=4, base_height=2, base_aspect_ratio = 1.75, dpi=600, units="in")

```

