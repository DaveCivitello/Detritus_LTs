---
title: "Plant schisto LTs"
author: "DJC"
date: "11/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Code for analysis of plant schisto LTs
Previously, we had applied GAMMs to these life table results from 2 experiments, but I think that was a mistake because the added complexity isn't really needed.

Here, we reanalyze the data using the final length and weekly averages of eggs and cercs as response variables, following methods from Civitello and Hartman 2020, Ecology and Johnson et al. 2014, Proc B, specifically just calculating weekly averages of egg laying and cerc shedding.
```{r packages, message=FALSE}
library(dplyr)
library(glmmTMB)
library(ggplot2)
library(cowplot)
library(emmeans)
library(stringr)
theme_set(theme_cowplot())
```


```{r data}
Betty_lt = read.csv("C:/RData/Dan Dissertation/Detritus LTs/Plant_species_LT.csv")
Betty_lt[,"Food"][which(Betty_lt[,"Food"] == "Good lab food")] = "Lab food"

L_max = aggregate(Length ~ Snail, FUN=max, data=Betty_lt)
C_tot = aggregate(Cerc ~ Snail, FUN=sum, data=Betty_lt, drop=F)
E_tot = aggregate(Eggs ~ Snail, FUN=sum, data=Betty_lt)
Surv = aggregate(Alive ~ Snail, FUN=sum, data=Betty_lt)
Infected = aggregate(Infected ~ Snail, FUN=unique, data=Betty_lt)
Food = aggregate(Food ~ Snail, FUN=unique, data=Betty_lt)

snails = full_join(Infected, Food, by="Snail")
snails = full_join(snails, L_max, by="Snail")
snails = full_join(snails, C_tot, by="Snail")
snails = full_join(snails, E_tot, by="Snail")
snails = full_join(snails, Surv, by="Snail")
snails[,"Food"] <- factor(snails[,"Food"], levels = c("Lab food", "Azolla", "Duckweed", "Water hyacinth", "Water lettuce"))
```

```{r per_week_analysis}
snails[,"Cerc_wk"] = snails[,"Cerc"]/(snails[,"Alive"]-3)
snails[,"Egg_wk"] = snails[,"Eggs"]/(snails[,"Alive"])

Lengths = lm(Length ~ Infected*Food, data=snails)
#summary(Lengths)
contrast_matrix_L = pwpm(emmeans(Lengths, pairwise ~ Food*Infected)$emmeans)

Eggs = lm(log(Egg_wk+1) ~ Infected*Food, data=snails)
#summary(Eggs)
contrast_matrix_E = pwpm(emmeans(Eggs, pairwise ~ Food*Infected)$emmeans)

Cercs = lm(log(Cerc_wk+1) ~ Food, data=subset(snails, Infected=="Y"))
#summary(Cercs)
contrast_matrix_C = pwpm(emmeans(Cercs, pairwise ~ Food)$emmeans)


```

```{r}
contrast_groups = function(contrast_matrix){
  trts = rownames(contrast_matrix)
  group_labels = rep("", times=length(trts))
  label_letters = letters[1:length(trts)]
  which_letter = 1
  for(i in 1:(length(trts)-1)){
    pvals = contrast_matrix[i,]
    pvals[1:i] = 0 # avoids double comparing previous treatments or itself to itself
    already_match = str_detect(group_labels, paste0("[", "z" , group_labels[i], "]"))
    new_matches = which(pvals > 0.05 & !already_match)
    if(length(new_matches) > 0){
      group_labels[c(i, new_matches)] = paste0(group_labels[c(i, new_matches)], label_letters[which_letter])
      which_letter = which_letter + 1
    }
  }
  data.frame(trts, group_labels)
}

```


## Generating treatment summaries - means & SEs
```{r treatments}
# Get means and SEs
meanL = aggregate(Length ~ Food*Infected, FUN=mean, data=snails)
meanE = aggregate(Egg_wk ~ Food*Infected, FUN=mean, data=snails)
meanC = aggregate(Cerc_wk ~ Food*Infected, FUN=mean, data=snails)

SEM <- function(x){sd(x)/sqrt(length(na.omit(x)))}

SE_L = aggregate(Length ~ Food*Infected, FUN=SEM, data=snails)
SE_E = aggregate(Egg_wk ~ Food*Infected, FUN=SEM, data=snails)
SE_C = aggregate(Cerc_wk ~ Food*Infected, FUN=SEM, data=snails)

treatments = data.frame(meanL, "Length_SE" = SE_L$Length, "Eggs" =meanE$Egg_wk, "Eggs_SE" = SE_E$Egg_wk)
treatments = full_join(treatments, meanC, by=c("Food", "Infected"))
treatments = full_join(treatments, SE_C, by=c("Food", "Infected"))
treatments = rename(treatments, Cercs = Cerc_wk.x)
treatments = rename(treatments, Cercs_SE = Cerc_wk.y)
treatments[,"Infected"] = ifelse(treatments[,"Infected"] == "N", "No", "Yes")


treatments[,"L_labs"] = contrast_groups(contrast_matrix_L)$group_labels
treatments[,"E_labs"] = contrast_groups(contrast_matrix_E)$group_labels
treatments[,"C_labs"] = c(rep(NA, times=5), contrast_groups(contrast_matrix_C)$group_labels)

treatments

```


## Building Plots

```{r plots}
pL = ggplot(data=treatments, aes(x=Food, y=Length, shape=Infected, fill=Infected)) + 
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position=c(0.05, 0.2), legend.title=element_text(size=10), legend.text=element_text(size=9), legend.spacing.x = unit(0, "cm"), 
        legend.spacing.y = unit(0, "cm"),
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + 
  geom_linerange(aes(ymin=Length - Length_SE, ymax=Length + Length_SE), position = position_dodge(width=0.3)) +
  geom_point(position = position_dodge(width=0.3)) + geom_text(aes(label=L_labs), position = position_dodge(width=1.2)) +
  scale_shape_manual(values=c(21, 21)) + scale_fill_manual(values = c("white", "black")) + ylim(c(0,20))

pE = ggplot(data=treatments, aes(x=Food, y=Eggs, shape=Infected, fill=Infected)) + 
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position="none",
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + 
  geom_linerange(aes(ymin=Eggs - Eggs_SE, ymax=Eggs + Eggs_SE), position = position_dodge(width=0.3)) +
  geom_point(position = position_dodge(width=0.3)) + geom_text(aes(label=E_labs), position = position_dodge(width=1.1)) +
  scale_shape_manual(values=c(21, 21)) + scale_fill_manual(values = c("white", "black"))

pC = ggplot(data=treatments, aes(x=Food, y=Cercs)) + geom_point() + geom_text(aes(label=C_labs), nudge_x = 0.2) +
  theme(plot.margin = unit(c(0, 0.25, 0.75, 0.75), "cm")) + 
  theme(legend.position="none", 
        axis.ticks.length = unit(-1.5, "mm"),
        axis.title.x = element_blank(), axis.text.x = element_text(size=8, margin = margin(t=3)),
        axis.title.y = element_blank(), axis.text.y = element_text(size=8, margin = margin(r=3))) + ylim(c(0,1300)) +
  geom_linerange(aes(ymin=Cercs - Cercs_SE, ymax=Cercs + Cercs_SE)) +
  scale_x_discrete(labels =  c("Lab\nfood", "Azolla", "Duckweed", "Water\nhyacinth", "Water\nlettuce"))


```


```{r plot_grid}
Fig1 = plot_grid(pL, pE, pC, align="v", ncol=1, nrow=3, axis="rltb", scale=1) +
  # y-axis labels
  draw_label("Final length, mm ± SE", x=0.04, y=0.85, angle=90, size=10) +
  draw_label("Weekly reproduction\nrate ± SE", x=0.04, y=0.51, angle=90, size=10) +
  draw_label("Cercarial production\nrate ± SE", x=0.04, y=0.2, angle=90, size=10) +
  # x-axis labels
  draw_label("Food resource", x = 0.55, y = 0.02, size=10) +
  # panel labels
  draw_label("A", x = 0.2, y = 0.985, size=10) + 
  # draw_label("Competitor size:", x = 0.75, y = 0.95, size=8, hjust=0.5) +
  # draw_label(expression(paste("P < ", 10^-12)), x = 0.75, y = 0.93, size=8, hjust=0.5) +
  # draw_label(expression(paste(R^2, " = 0.68")), x = 0.75, y = 0.91, size=8, hjust=0.5) +
  draw_label("B", x = 0.2, y = 0.65, size=10) +
  # draw_label("Competitor size:", x = 0.75, y = 0.45, size=8, hjust=0.5) +
  # draw_label(expression(paste("P < ", 10^-12)), x = 0.75, y = 0.43, size=8, hjust=0.5) +
  # draw_label(expression(paste(R^2, " = 0.70")), x = 0.75, y = 0.41, size=8, hjust=0.5) +
  draw_label("C", x = 0.2, y = 0.32, size=10) #+
  # draw_label("Competitor size:", x = 0.75, y = 0.16, size=8, hjust=0.5) +
  # draw_label("P = 0.003", x = 0.75, y = 0.14, size=8, hjust=0.5)

setwd("C:/RData")
save_plot("Fig1_Detritus.png", Fig1, ncol=1, nrow=3, base_height=2, base_aspect_ratio = 1.75, dpi=600, units="in")

```

